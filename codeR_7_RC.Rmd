---
title: "Tugas Besar Pemstok"
author: "Kelompok 7 RC"
date: "2025-11-25"
output: html_document
---

### Kelompok 7 RC

1.  121450145	MAYADA
2.  122450096	GYMNASTIAR AL KHOARIZMY
3.  121450079	Dwi Sulistiani
4.  121450024	EVAN APRIANTO
5.  121450030	Pramudya Wibowo

## Pemodelan Kepadatan Pengunjung Perpustakaan GK 1 ITERA dengan Rantai Markov

```{r}
# Langkah 1: Muat paket yang dibutuhkan untuk analisis rantai Markov agregat
required_packages <- c("readxl", "dplyr", "tidyr", "lubridate", "markovchain", "ggplot2", "igraph", "janitor", "expm", "gganimate", "gifski")
invisible(lapply(required_packages, function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
  library(pkg, character.only = TRUE)
}))
```

```{r}
# Langkah 2: Baca data dan bentuk agregasi harian (hari operasional saja)
data_path <- "M:/ITERA/Semester 7/Pemodelan Stokastik/Tubes/visitor_list.xlsx"
raw_visits <- readxl::read_excel(data_path) %>%
  janitor::clean_names()

daily_visits_full <- raw_visits %>%
  mutate(
    tanggal_kunjungan = lubridate::ymd_hms(tanggal_kunjungan, tz = "Asia/Jakarta"),
    tanggal = as.Date(tanggal_kunjungan)
  ) %>%
  group_by(tanggal) %>%
  summarise(jumlah_kunjungan = n(), .groups = "drop") %>%
  tidyr::complete(tanggal = seq(min(tanggal), max(tanggal), by = "day"),
                  fill = list(jumlah_kunjungan = 0))

daily_visits <- daily_visits_full %>%
  mutate(wday_index = lubridate::wday(tanggal, week_start = 1)) %>%
  filter(wday_index <= 5) %>%
  select(-wday_index)

cat(sprintf("Total hari operasional yang dianalisis: %d dari %d hari kalender (Sabtu & Minggu dihapus)\n",
            nrow(daily_visits), nrow(daily_visits_full)))
daily_visits %>% head()
```

```{r}
# Langkah 2.5: Visualisasi Data Harian (Deskripsi Data)
plot_timeseries <- ggplot(daily_visits, aes(x = tanggal, y = jumlah_kunjungan)) +
  geom_line(color = "#112bc1ff", alpha = 0.8) +
  geom_point(color = "#fb0000ff", size = 0.5) +
  labs(
    title = "Tren Kunjungan Harian Perpustakaan GK1",
    subtitle = "Data Hari Operasional (Senin-Jumat)",
    x = "Tanggal",
    y = "Jumlah Kunjungan Harian"
  ) +
  theme_minimal()

print(plot_timeseries)
```

```{r}
# Langkah 2.7: Statistik deskriptif kunjungan hari operasional
descriptive_stats <- daily_visits %>%
  summarise(
    total_hari = n(),
    rata_rata = mean(jumlah_kunjungan),
    median = median(jumlah_kunjungan),
    sd = sd(jumlah_kunjungan),
    minimum = min(jumlah_kunjungan),
    q1 = quantile(jumlah_kunjungan, 0.25),
    q3 = quantile(jumlah_kunjungan, 0.75),
    maksimum = max(jumlah_kunjungan)
  )
cat("Ringkasan statistik keseluruhan:\n")
print(descriptive_stats)

weekday_stats <- daily_visits_full %>%
  mutate(
    wday_label = lubridate::wday(tanggal, label = TRUE, abbr = FALSE, week_start = 1)
  ) %>%
  filter(lubridate::wday(tanggal, week_start = 1) <= 5) %>%
  group_by(wday_label) %>%
  summarise(
    hari_operasional = n(),
    rata_rata = mean(jumlah_kunjungan),
    median = median(jumlah_kunjungan),
    sd = sd(jumlah_kunjungan)
  ) %>%
  arrange(hari_operasional)

cat("\nRingkasan per hari (Senin-Jumat):\n")
print(weekday_stats)
```

```{r}
# Inspeksi nama kolom untuk debugging struktur data
colnames(readxl::read_excel(data_path))
```

```{r}
# Langkah 3: Identifikasi ruang keadaan berdasarkan kuantil 33% dan 66%
positive_visits <- daily_visits %>% filter(jumlah_kunjungan > 0)
q33 <- quantile(positive_visits$jumlah_kunjungan, 0.33, na.rm = TRUE)
q66 <- quantile(positive_visits$jumlah_kunjungan, 0.66, na.rm = TRUE)
cat(sprintf("Batas kuantil: q33 = %.2f, q66 = %.2f\n", q33, q66))
daily_states <- daily_visits %>%
  mutate(
    status_kepadatan = case_when(
      jumlah_kunjungan <= q33 ~ "Rendah",
      jumlah_kunjungan <= q66 ~ "Sedang",
      TRUE ~ "Tinggi"
    )
  )
daily_states %>% count(status_kepadatan)
```

```{r}
# Langkah 3.5: Menampilkan Cuplikan Tabel Klasifikasi State
# Ini akan digunakan untuk tabel contoh di laporan LaTeX

cat("Contoh Tabel Klasifikasi State:\n")
print(daily_states, n = 10)
```

```{r}
# Langkah 4: Pembuatan model Markov dan matriks transisi agregat
state_levels <- c("Rendah", "Sedang", "Tinggi")
state_sequence <- factor(daily_states$status_kepadatan, levels = state_levels, ordered = TRUE)
mc_fit <- markovchain::markovchainFit(data = as.character(state_sequence), method = "mle")
mc_perpustakaan <- mc_fit$estimate
mc_perpustakaan@transitionMatrix
```

```{r}
# Langkah 5: Diagram transisi dan heatmap matriks transisi
old_par <- par(no.readonly = TRUE)
par(mar = c(1, 1, 3.5, 1), xpd = NA)
layout_coords <- matrix(c(-0.6, -0.4,
                          0.6, -0.4,
                          0.0, 0.6),
                        ncol = 2, byrow = TRUE,
                        dimnames = list(state_levels, c("x", "y")))
plot(mc_perpustakaan,
     main = "Diagram Transisi Rantai Markov Kepadatan Harian",
     edge.arrow.size = 0.9,
     edge.curved = 0.2,
     vertex.size = 55,
     vertex.label.cex = 1.3,
     edge.label.cex = 1.1,
     layout = layout_coords)
par(old_par)
transition_df <- as.data.frame(mc_perpustakaan@transitionMatrix) %>%
  tibble::rownames_to_column("Dari") %>%
  tidyr::pivot_longer(-Dari, names_to = "Ke", values_to = "Probabilitas") %>%
  mutate(
    Dari = factor(Dari, levels = state_levels),
    Ke = factor(Ke, levels = state_levels)
  )
ggplot(transition_df, aes(x = Ke, y = Dari, fill = Probabilitas)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", Probabilitas)), color = "black", size = 3) +
  scale_x_discrete(limits = state_levels) +
  scale_y_discrete(limits = rev(state_levels)) +
  scale_fill_gradient(low = "#F1F8E9", high = "#0d31c2ff") +
  labs(title = "Heatmap Matriks Transisi", x = "State (t+1)", y = "State (t)") +
  theme_minimal()
```

```{r}
# Langkah 6: Probabilitas langkah ke-n dan contoh prediksi
P2 <- (mc_perpustakaan@transitionMatrix) %^% 2
P7 <- (mc_perpustakaan@transitionMatrix) %^% 7
P30 <- (mc_perpustakaan@transitionMatrix) %^% 30
cat("Matriks P^2:\n"); print(P2)
cat("\nMatriks P^7:\n"); print(P7)
cat("\nMatriks P^30:\n"); print(P30)
initial_state <- matrix(c(1, 0, 0), nrow = 1, dimnames = list(NULL, state_levels))
prob_after_7 <- initial_state %*% P7
cat("\nDistribusi probabilitas setelah 7 hari jika awalnya Rendah:\n")
prob_after_7
```

```{r}
# Langkah 7: Distribusi stasioner dan validasi manual
steady_state <- markovchain::steadyStates(mc_perpustakaan)
colnames(steady_state) <- state_levels
cat("Distribusi stasioner (steady state):\n")
steady_state
P <- mc_perpustakaan@transitionMatrix
A <- t(P) - diag(3)
A_reduced <- rbind(A[1:(nrow(A) - 1), ], rep(1, ncol(A)))
b <- c(rep(0, nrow(A) - 1), 1)
manual_pi <- solve(A_reduced, b)
names(manual_pi) <- state_levels
cat("\nDistribusi stasioner (perhitungan manual):\n")
manual_pi
```

```{r}
# Langkah 8: Klasifikasi ruang keadaan dan sifat rantai
is_irreducible <- markovchain::is.irreducible(mc_perpustakaan)
chain_period <- markovchain::period(mc_perpustakaan)
is_aperiodic <- chain_period == 1
cat(sprintf("Rantai irreducible: %s\n", is_irreducible))
cat(sprintf("Rantai aperiodik: %s (period = %d)\n", is_aperiodic, chain_period))
cat("\nRingkasan rantai Markov:\n")
summary(mc_perpustakaan)
```

```{r}
# Langkah 9: Mean First Passage Time (MFPT) sebagai analisis tambahan
mfpt_matrix <- markovchain::meanFirstPassageTime(mc_perpustakaan)
cat("Matriks Mean First Passage Time (hari):\n")
mfpt_matrix
```
